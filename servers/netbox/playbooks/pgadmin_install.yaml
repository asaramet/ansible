---
# Install/update pgAdmin 4 on a Debian Linux server
#
# RUN
# - development server
#   ansible-playbook playbooks/pgadmin_install.yaml
#
# - production server
#    ansible-playbook playbooks/pgadmin_install.yaml -e production=true

- name: Define global variables
  hosts: localhost
  gather_facts: false
  tags: global
  vars: 
    production: false
  tasks:
    - name: Set server 
      set_fact:
        server: "{{ 'hs_netbox' if  production else 'local' }}"

    - name: "Running install on: "
      debug:
        msg: "{{ server }}"

    - name: "Is it a production server?"
      debug:
        msg: "{{ production }}"

- name: Get pgAdmin source code
  hosts: localhost
  gather_facts: false
  tags: source
  vars: 
    src_dir: "{{ inventory_dir }}/src/pgadmin"
    git_repo: "https://github.com/pgadmin-org/pgadmin4.git"
  tasks:
    - name: Check if git is installed
      command: git --version
      register: git_version
      changed_when: false
      ignore_errors: true

    - name: Check for URL rewriting git config
      command: git config --global --get-regexp "url.*insteadof"
      register: git_url_rewrite_config
      ignore_errors: true
      changed_when: false
      failed_when: false

    - name: Debug git URL rewrite configuration
      debug:
        msg: "Git URL rewrite config: {{ git_url_rewrite_config.stdout | default('None found') }}"

    - name: Set fact for URL rewriting detection
      set_fact:
        has_url_rewrite: "{{ git_url_rewrite_config.stdout is defined and git_url_rewrite_config.stdout | length > 0 and 'ssh//git@github.com' in git_url_rewrite_config.stdout }}"

    - name: Ensure destination directory exists, and create if not
      file:
        path: "{{ src_dir }}"
        state: directory
        mode: '0755'
      register: dest_dir_stat

    - name: Check if destination is already a git repository
      command: git -C {{ src_dir }} rev-parse --is-inside-work-tree
      register: git_repo_check
      ignore_errors: true

    - name: Test network connectivity to GitHub
      uri:
        url: "https://github.com"
        method: GET
        status_code: 200
        timeout: 10
      register: github_connectivity
      ignore_errors: true

    - name: Test connectivity to specific repository URL
      uri:
        url: "{{ git_repo }}"
        method: GET
        status_code: 200
        timeout: 10
      register: repo_connectivity
      ignore_errors: true

    - name: Debug GitHub connectivity
      debug:
        msg: "GitHub connectivity: {{ 'Success' if github_connectivity.status == 200 else 'Failed' }}"

    - name: Debug repository URL connectivity
      debug:
        msg: "Repository URL connectivity: {{ 'Success' if repo_connectivity.status == 200 else 'Failed' }}"

    - name: Temporarily disable URL rewriting if present
      command: git config --global --unset "url.ssh//git@github.com/.insteadof"
      register: unset_url_rewrite
      ignore_errors: true
      changed_when: unset_url_rewrite.rc == 0
      when: has_url_rewrite

    - name: Update git repository
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: "{{ src_dir }}"
        archive: "{{ inventory_dir }}/src/pgadmin.zip"
        version: master
        update: true
        force: true
      register: git_result
      ignore_errors: true

    - name: Restore URL rewriting if it was disabled
      command: git config --global "url.ssh//git@github.com/.insteadof" "https://github.com/"
      when: unset_url_rewrite is defined and unset_url_rewrite.changed is defined and unset_url_rewrite.changed
      ignore_errors: true

    - name: Debug git clone result
      debug:
        var: git_result

    - name: Show detailed error message if git clone failed
      fail:
        msg: |
          Failed to clone pgAdmin repository.
          Error details: {{ git_result.msg if git_result.msg is defined else 'No error message available' }}
          Command executed: {{ git_result.cmd if git_result.cmd is defined else 'No command recorded' }}
          Check git installation and network connectivity.
      when: git_result.failed is defined and git_result.failed

    - name: Try manual git clone for debugging
      command: git clone -v {{ git_repo }} {{ src_dir }}
      register: manual_git_result
      ignore_errors: true
      when: git_result.failed is defined and git_result.failed

    - name: Show manual git clone result
      debug:
        var: manual_git_result
      when: manual_git_result is defined

- name: Install pgAdmin 4
  hosts: "{{ hostvars['localhost']['server'] }}"
  gather_facts: false
  #become: true # run as root
  tags: install
  vars: 
    production: false
    src_archive: "{{ inventory_dir }}/src/pgadmin.zip"

  tasks:
    - name: ==-- Debug --==
      debug:
        msg: "src_archive {{ src_archive }}"
