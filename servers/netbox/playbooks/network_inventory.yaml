---
# Create a netbox_inventory database on a NetBox PostgreSQL server
#
# RUN
# - development server
#   ansible-playbook playbooks/network_inventory.yaml
#
# - production server
#    ansible-playbook playbooks/network_inventory.yaml -e production=true

- name: Define global variables
  hosts: localhost
  gather_facts: false
  tags: global
  vars:
    production: &production false
    postgresql_version: &postgresql_version "17"
    allowed_network: &allowed_network "{{ vault_allowed_network }}" # Admins network set in vault
  tasks:
    - name: Set server 
      set_fact:
        server: "{{ 'hs_netbox' if  production else 'local' }}"

    - name: "Running install on: "
      debug:
        msg: "{{ server }}"

    - name: "Is it a production server?"
      debug:
        msg: "{{ production }}"

- name: Configure PostgreSQL for Remote Connections
  hosts: "{{ hostvars['localhost']['server'] }}"
  gather_facts: false
  become: true
  become_method: su
  become_user: postgres
  vars:
    production: *production
    postgresql_version: *postgresql_version
    # Set the path to the config files based on your Debian/PostgreSQL version
    pg_conf_path: "/etc/postgresql/{{ postgresql_version }}/main/postgresql.conf"
    allowed_network: *allowed_network
  tasks:
    # Handle the firewall opening (needs become: true and standard user permissions)
    # This task should be run as root/standard become user, NOT 'postgres'
    - name: Ensure PostgreSQL port 5432 is open (on production server)
      community.general.ufw:
        rule: allow
        port: '5432'
        proto: tcp
        src: "{{ allowed_network }}"
      become_user: root
      when: production | bool

    # Allow PostgreSQL to listen on all interfaces
    - name: Set listen_addresses to '*' in postgresql.conf
      ansible.builtin.lineinfile:
        path: "{{ pg_conf_path }}"
        regexp: '^#?listen_addresses ='
        line: "listen_addresses = '*'"
        state: present
      become_user: postgres
      notify: Restart postgresql

  handlers:
    - name: Restart postgresql
      ansible.builtin.service:
        name: postgresql
        state: restarted

- name: Configure PostgreSQL network inventory database
  hosts: "{{ hostvars['localhost']['server'] }}"
  gather_facts: false
  become: true # run as root
  tags: postgresql
  #become_method: su
  become_user: postgres # change to postgres user
  vars:
    sql_inventory_pass: "{{ vault_sql_inventory_pass }}"
    allowed_network: *allowed_network
    postgresql_version: *postgresql_version
    pg_hba_path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
  tasks:
    - name: Create a new PostgreSQL database with the name 'network_inventory'
      community.postgresql.postgresql_db:
        login_user: postgres
        name: network_inventory
        comment: Network Inventory database for manual asset tracking

    - name: Create PostgreSQL group role 'netzadmins'
      community.postgresql.postgresql_user:
        login_user: postgres
        name: netzadmins
        state: present
        # This role is a group, not a user, so they cannot log in directly
        comment: Group role for network administrators

    - name: Create a new user 'netzadmin' and add it to 'netzadmins' group
      community.postgresql.postgresql_user:
        login_user: postgres
        name: netzadmin
        password: "{{ sql_inventory_pass }}"
        comment: Network Inventory database user

    - name: Grant role (group) netzadmins to netzadmin user 
      community.postgresql.postgresql_membership:
        login_user: postgres
        group: netzadmins
        target_roles:
          - netzadmin
        state: present

    - name: Grant all privileges on network_inventory database to netzadmins group
      community.postgresql.postgresql_privs:
        login_user: postgres
        login_db: network_inventory
        state: present
        privs: ALL
        type: database
        roles: netzadmins

    - name: Grant all privileges on all tables in network_inventory database
      community.postgresql.postgresql_privs:
        login_user: postgres
        login_db: network_inventory
        state: present
        privs: ALL
        type: table
        objs: ALL_IN_SCHEMA
        schema: public
        roles: netzadmins

    - name: Grant all privileges on all sequences in network_inventory database
      community.postgresql.postgresql_privs:
        login_user: postgres
        login_db: network_inventory
        state: present
        privs: ALL
        type: sequence
        objs: ALL_IN_SCHEMA
        schema: public
        roles: netzadmins

    # Allow connections for the new user/database
    - name: Add pg_hba.conf entry for remote access to netzadmins group
      community.postgresql.postgresql_pg_hba:
        dest: "{{ pg_hba_path }}"
        state: present
        rules:
          - contype: host # 'host' means connection over TCP/IP, not using SSL
            database: network_inventory
            user: netzadmins
            address: "{{ allowed_network }}"
            method: md5
      notify: Restart postgresql
      
    - name: Create devices table in network_inventory database
      community.postgresql.postgresql_query:
        login_user: postgres
        login_db: network_inventory
        query: |
          -- Create table if it doesn't exist (without UNIQUE constraint)
          CREATE TABLE IF NOT EXISTS devices (
            id SERIAL PRIMARY KEY,
            hostname VARCHAR(255) NOT NULL,
            serial_number VARCHAR(100),
            inventory_number VARCHAR(100),
            active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Drop UNIQUE constraint if it exists (from old schema)
          ALTER TABLE devices 
          DROP CONSTRAINT IF EXISTS devices_hostname_key;

          -- Create indexes (IF NOT EXISTS makes this idempotent)
          CREATE INDEX IF NOT EXISTS idx_hostname ON devices(hostname);
          CREATE INDEX IF NOT EXISTS idx_active ON devices(active);
          CREATE INDEX IF NOT EXISTS idx_serial_number ON devices(serial_number);

          -- Create a composite unique constraint for hostname + serial_number
          -- This prevents exact duplicates while allowing same hostname with different serials
          CREATE UNIQUE INDEX IF NOT EXISTS idx_hostname_serial 
          ON devices(hostname, serial_number) 
          WHERE serial_number IS NOT NULL;

          -- Comments
          COMMENT ON TABLE devices IS 'Manual network device inventory tracking';
          COMMENT ON COLUMN devices.hostname IS 'Device hostname or FQDN (non-unique to allow inactive/replacement devices)';
          COMMENT ON COLUMN devices.serial_number IS 'Manufacturer serial number';
          COMMENT ON COLUMN devices.inventory_number IS 'Internal inventory tracking number';
          COMMENT ON COLUMN devices.active IS 'Whether device is currently active in network';

  handlers:
    - name: Restart postgresql
      ansible.builtin.service:
        name: postgresql
        state: restarted
      become_user: root
