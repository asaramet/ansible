---
# Configure pgAdmin 4 web UI on a Debian Linux server
#
# RUN
# - development server
#   ansible-playbook playbooks/pgadmin_config.yaml
#
# - production server
#    ansible-playbook playbooks/pgadmin_config.yaml -e production=true

- name: Define global variables
  hosts: localhost
  gather_facts: false
  tags: global
  vars: 
    production: false
  tasks:
    - name: Set production flag from environment if not defined
      set_fact:
        production: "{{ production | default(false) | bool }}"
      when: production is not defined

    - name: Set server 
      set_fact:
        server: "{{ 'hs_netbox' if production else 'local' }}"

    - name: "Running install on: {{ server }}"
      debug:
        msg: "{{ server }}"

    - name: "Is it a production server?"
      debug:
        msg: "{{ production }}"

- name: Configure pgAdmin 4 on Nginx sub-path
  hosts: "{{ hostvars['localhost']['server'] }}"
  gather_facts: false
  become: true
  tags: pgadmin_config
  vars: 
    production: false
    pgadmin_install_dir: /opt/pgadmin
    pgadmin_subpath: /pgadmin
    pgadmin_port: 5050
    nginx_domain: netbox
    pgadmin_venv_path: /usr/pgadmin4/venv/bin/python3
    #pgadmin_user: www-data
    pgadmin_user: postgres
    pgadmin_workdir: /usr/pgadmin4/web
    pgadmin_email: "{{ vault_pgadmin_email | default(omit) }}" 
    pgadmin_password: "{{ vault_pgadmin_password | default(omit) }}"

  tasks:
    - name: Create pgAdmin installation directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode | default('0755') }}"
        owner: "{{ pgadmin_user }}"
        group: "{{ pgadmin_user }}"
      loop:
        - { path: "{{ pgadmin_install_dir }}", mode: '0755' }
        - { path: "{{ pgadmin_install_dir }}/logs", mode: '0755' }
        - { path: "{{ pgadmin_install_dir }}/data", mode: '0700' }
      loop_control:
        label: "{{ item.path }}"

    - name: Set Python executable path
      ansible.builtin.set_fact:
        python_exec: "{{ pgadmin_venv_path }}"
      changed_when: false

    - name: Create pgAdmin configuration file
      ansible.builtin.template:
        dest: "{{ pgadmin_install_dir }}/config_local.py"
        owner: "{{ pgadmin_user }}"
        group: "{{ pgadmin_user }}"
        mode: '0600'
        src: templates/pgadmin_config.j2
      notify: restart pgadmin4

    - name: Create symbolic link for config (idempotent)
      ansible.builtin.file:
        src: "{{ pgadmin_install_dir }}/config_local.py"
        dest: /usr/pgadmin4/web/config_local.py
        state: link
        owner: "{{ pgadmin_user }}"
        group: "{{ pgadmin_user }}"
        force: yes

    - name: Check if pgAdmin database exists 
      stat: 
        path: "{{ pgadmin_install_dir }}/data/pgadmin4.db"
      register: pgadmin_db 

    - name: Initialize pgAdmin database
      ansible.builtin.expect: 
        command: "{{ python_exec }} setup.py setup-db"
        chdir: /usr/pgadmin4/web
        responses:
          'Email address:': "{{ pgadmin_email }}"
          'Password:': "{{ pgadmin_password }}"
          'Retype password:': "{{ pgadmin_password }}"
        timeout: 30
      become_user: "{{ pgadmin_user }}"
      environment:
        HOME: /tmp
        PYTHONPATH: /usr/pgadmin4/web
      when: not pgadmin_db.stat.exists

    - name: Create pgAdmin systemd service (idempotent)
      ansible.builtin.template:
        dest: /etc/systemd/system/pgadmin4.service
        mode: '0644'
        src: templates/pgadmin4.service.j2
      notify: restart pgadmin4

    - name: Ensure nginx configuration is present
      ansible.builtin.template:
        src: "{{ local_src_folder }}/nginx.conf"
        dest: /etc/nginx/sites-available/netbox
        backup: yes
        owner: root
        mode: 0644
      notify: reload nginx
      when: local_src_folder is defined

    - name: Ensure pgAdmin4 service is enabled and running
      ansible.builtin.systemd:
        name: pgadmin4
        enabled: true
        state: started
        daemon_reload: true
      register: pgadmin_service_status
      until: pgadmin_service_status is success
      retries: 3
      delay: 5
      no_log: true

    - name: Verify pgAdmin4 is listening on configured port
      ansible.builtin.wait_for:
        port: "{{ pgadmin_port }}"
        timeout: 30
        delay: 5
      when: pgadmin_service_status is changed

    - name: Display completion message
      ansible.builtin.debug:
        msg: "pgAdmin4 has been successfully configured and is running on port {{ pgadmin_port }}"
      when: not production

  handlers:
    - name: restart pgadmin4
      ansible.builtin.systemd:
        name: pgadmin4
        state: restarted
        daemon_reload: true
      listen: "restart pgadmin services"
      no_log: true

    - name: reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
      listen: "restart pgadmin services"
      when: nginx_domain is defined

    - name: verify pgadmin service
      ansible.builtin.service_facts:
      listen: "restart pgadmin services"