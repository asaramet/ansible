---
- name: Define global variables, gather localhost data
  hosts: localhost
  gather_facts: false
  tags: localhost
  vars: 
    clear: &clear false
    #server: &server debian12-ansible
    server: &server hs_netbox 
    plugins: &plugins
      - netbox-bgp
      - netbox-documents
      - netbox-floorplan-plugin
      - netbox_acls
      - netbox-plugin-dns
      - netbox-qrcode
      - netbox-reorder-rack
      - netbox-topology-views
      - netbox-inventory

- name: Install NetBox plugins
  hosts: *server
  gather_facts: false
  become: true # run as root
  tags: plugins
  vars:
    - plugins: *plugins
    - clear: *clear
  tasks:
    - name: Copy pip packages from localhost to the remote server
      copy:
        src: "{{ inventory_dir }}/pip_packages/plugins"
        dest: /opt/
      when: not clear

    - name: Install apps with pip from the local directory
      pip:
        virtualenv: /opt/netbox/venv/
        extra_args: "--no-index --find-links=file:///opt/plugins"
        name: "{{ item }}"
      loop: "{{ plugins }}"
      when: not clear

    - name: Copy local 'configuration.py' to remote 'netbox' directory
      copy:
        src: "{{ local_src_folder }}/configuration.py"
        dest: /opt/netbox/netbox/netbox
        owner: netbox
        group: netbox
    
- name: Remove plugins folder und uninstall plugins
  hosts: *server
  gather_facts: false
  become: true # run as root
  tags: clear
  vars:
    - clear: *clear
    - plugins: *plugins
  tasks:
    - name: Remove the '/opt/plugins/' folder
      file: 
        path: /opt/plugins
        state: absent
      when: clear
    
    - name: Uninstall all the plugins
      pip: 
        virtualenv: /opt/netbox/venv/
        state: absent
        name: "{{ item }}"
      loop: "{{ plugins }}"
      when: clear